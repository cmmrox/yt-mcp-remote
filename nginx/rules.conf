# Nginx Reverse Proxy Configuration for MCP Services
# This file supports multiple service routing with SSL termination

# HTTP to HTTPS redirect
server {
    listen 80;
    server_name odoo-mcp.cssapps.net;

    return 301 https://$server_name$request_uri;
}

# Main HTTPS server block for odoo-mcp.cssapps.net
server {
    listen 443 ssl;
    server_name odoo-mcp.cssapps.net;

    # SSL Configuration
    ssl_certificate /etc/nginx/ssl/server.crt;
    ssl_certificate_key /etc/nginx/ssl/server.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    # Client settings
    client_max_body_size 1024m;

    # Proxy buffer settings (from K8s ingress)
    proxy_buffer_size 128k;
    proxy_buffers 4 256k;
    proxy_busy_buffers_size 256k;

    # Proxy timeout settings (from K8s ingress)
    proxy_connect_timeout 600s;
    proxy_read_timeout 600s;
    proxy_send_timeout 600s;

    # Location block for yt-mcp-server
    location / {
        # Reverse proxy to yt-mcp-server container
        proxy_pass http://yt-mcp-server:8000;

        # Proxy headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $server_name;

        # WebSocket support (if needed for MCP)
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # Disable buffering for streaming responses
        proxy_buffering off;
    }

    # Access and error logs
    access_log /var/log/nginx/odoo-mcp.access.log;
    error_log /var/log/nginx/odoo-mcp.error.log;
}

# ============================================================
# TEMPLATE: Add new services below using this format
# ============================================================

# Example: New service template
# server {
#     listen 80;
#     server_name new-service.cssapps.net;
#     return 301 https://$server_name$request_uri;
# }
#
# server {
#     listen 443 ssl;
#     server_name new-service.cssapps.net;
#
#     # SSL Configuration
#     ssl_certificate /etc/nginx/ssl/server.crt;
#     ssl_certificate_key /etc/nginx/ssl/server.key;
#     ssl_protocols TLSv1.2 TLSv1.3;
#     ssl_ciphers HIGH:!aNULL:!MD5;
#     ssl_prefer_server_ciphers on;
#
#     # Client settings
#     client_max_body_size 1024m;
#
#     # Proxy buffer settings
#     proxy_buffer_size 128k;
#     proxy_buffers 4 256k;
#     proxy_busy_buffers_size 256k;
#
#     # Proxy timeout settings
#     proxy_connect_timeout 600s;
#     proxy_read_timeout 600s;
#     proxy_send_timeout 600s;
#
#     location / {
#         proxy_pass http://container-name:PORT;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#         proxy_set_header X-Forwarded-Host $server_name;
#
#         proxy_http_version 1.1;
#         proxy_set_header Upgrade $http_upgrade;
#         proxy_set_header Connection "upgrade";
#         proxy_buffering off;
#     }
#
#     access_log /var/log/nginx/new-service.access.log;
#     error_log /var/log/nginx/new-service.error.log;
# }

# ============================================================
# ADVANCED ROUTING EXAMPLES (from K8s ingress patterns)
# ============================================================

# Example: Path-based routing for a single domain
# server {
#     listen 443 ssl;
#     server_name multi-service.cssapps.net;
#
#     ssl_certificate /etc/nginx/ssl/server.crt;
#     ssl_certificate_key /etc/nginx/ssl/server.key;
#
#     # Route /api/* to api-service
#     location /api/ {
#         proxy_pass http://api-service:8080/;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#     }
#
#     # Route /docs/* to docs-service
#     location /docs/ {
#         proxy_pass http://docs-service:3000/;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#     }
#
#     # Default route to frontend
#     location / {
#         proxy_pass http://frontend-service:80/;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#     }
# }
